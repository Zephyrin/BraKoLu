<div class="inline">
  <div class="brew-container"
       [@brewExpand]="orderDisplayService.brewExpanded ? 'expanded': 'collapsed'">
    <mat-selection-list class="brew-list"
                        #brews>
      <mat-list-option *ngFor="let brew of brewsDetail"
                       [value]="brew"
                       [selected]="brew.isApply">
        <mat-icon matListIcon
                  *ngIf="brew.canBeBrew">thumb_up</mat-icon>
        <mat-icon matListIcon
                  *ngIf="!brew.canBeBrew">warning</mat-icon>
        <div class="brew-custom-placeholder"></div>
        {{brew.brew.number}} - {{brew.brew.name}}<br />{{brew.brew.started | date: 'dd-M-yyyy' }}
      </mat-list-option>
    </mat-selection-list>
  </div>

  <fieldset [disabled]="stockService.loadingSource"
            class="full-width padding">
    <mat-accordion multi>
      <mat-expansion-panel *ngFor="let accordion of accordionOrder"
                           [expanded]="accordion.expanded">
        <mat-expansion-panel-header>
          <mat-panel-title>
            {{accordion.childName.viewValue}}
          </mat-panel-title>
        </mat-expansion-panel-header>
        <div class="table-responsive">
          <mat-table class="full-width"
                     #matTable
                     matSort
                     multiTemplateDataRows
                     [dataSource]="accordion.orderStocks">
            <ng-container matColumnDef="expanded">
              <th mat-header-cell
                  *matHeaderCellDef>
              </th>
              <td mat-cell
                  (click)="selectedRow($event, row)"
                  *matCellDef="let row"
                  class="cursor">
                <div class="expanded">
                  <mat-icon *ngIf="row.expanded">expand_less</mat-icon>
                  <mat-icon *ngIf="!row.expanded">expand_more</mat-icon>
                </div>
              </td>
            </ng-container>
            <ng-container [matColumnDef]="header.value"
                          *ngFor="let header of headersStock">
              <th mat-header-cell
                  class="header-box"
                  [mat-sort-header]="header.value"
                  *matHeaderCellDef>{{header.viewValue}}
              </th>
              <td mat-cell
                  *matCellDef="let element"
                  [ngSwitch]="header.value">
                <span *ngSwitchDefault> {{ getDisplay(header.value, element) }} </span>
                <div *ngSwitchCase="'quantityOrder'">
                  <mat-form-field appearance="legacy"
                                  *ngFor="let stock of element.orderStocks">
                    <mat-label></mat-label>
                    <input matInput
                           [placeholder]="'Ex: 23 ' + element.ingredient.unit"
                           type="number"
                           step="any"
                           min="0"
                           (change)="updateStock($event, element, stock, 'quantity')"
                           [value]="stock.quantity / element.ingredient.unitFactor">
                  </mat-form-field>
                </div>
                <div *ngSwitchCase="'price'">
                  <mat-form-field appearance="legacy"
                                  *ngFor="let stock of element.orderStocks">
                    <mat-label></mat-label>
                    <input matInput
                           [placeholder]="'Ex: 23 €'"
                           type="number"
                           step="any"
                           min="0"
                           (change)="updateStock($event, element, stock, 'price')"
                           [value]="stock.price">
                  </mat-form-field>
                </div>
                <div *ngSwitchCase="'supplier'">
                  <mat-form-field appearance="legacy"
                                  *ngFor="let stock of element.orderStocks">
                    <mat-label></mat-label>
                    <mat-select [value]="stock.supplier"
                                [compareWith]="compareId"
                                [disabled]="!stock.id || stockService.loadingSource"
                                (selectionChange)="updateStockSupplier($event, element, stock)"
                                placeholder="Fournisseur">
                      <mat-option [value]="undefined">Sans fournisseur</mat-option>
                      <mat-option *ngFor="let supplier of supplierService.model"
                                  [value]="supplier">
                        {{supplier.name}}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
                <div *ngSwitchCase="'deliveryPlanned'">

                  <div *ngFor="let stock of element.orderStocks; let index = index;"
                       class="inline">
                    <mat-form-field appearance="legacy">
                      <mat-label></mat-label>
                      <input matInput
                             [disabled]="!stock.id || stockService.loadingSource"
                             [matDatepicker]="deliveryScheduledFor"
                             (dateInput)="updateDate($event, element, stock, 'deliveryScheduledFor')"
                             (dateChange)="updateDate($event, element, stock, 'deliveryScheduledFor')"
                             [value]="stock.deliveryScheduledFor">
                      <mat-datepicker-toggle matSuffix
                                             [for]="deliveryScheduledFor"></mat-datepicker-toggle>
                      <mat-datepicker #deliveryScheduledFor></mat-datepicker>
                    </mat-form-field>
                    <button mat-icon-button
                            (click)="removeStockOrder($event, element, index)">
                      <mat-icon>remove_circle_outline</mat-icon>
                    </button>
                  </div>
                </div>
              </td>

            </ng-container>
            <ng-container matColumnDef="action">
              <th mat-header-cell
                  *matHeaderCellDef>
              </th>
              <td mat-cell
                  *matCellDef="let row">
                <div class="action-container">
                  <button mat-icon-button
                          (click)="addNewStockOrder($event, row)"
                          [attr.aria-label]="'Ajouter un nouvel ingrédient'">
                    <mat-icon>add_task</mat-icon>
                  </button>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="expandedDetail">
              <td mat-cell
                  *matCellDef="let element"
                  [attr.colspan]="displayedColumnsStock.length">
                <div class="element-detail"
                     [@detailExpand]="element.expanded ? 'expanded' : 'collapsed'">
                  <table mat-table
                         class="full-width"
                         matSort
                         [dataSource]="element.brewIngredients">
                    <ng-container [matColumnDef]="header.value"
                                  *ngFor="let header of headersBrewIngredient">
                      <th mat-header-cell
                          class="header-box"
                          [mat-sort-header]="header.value"
                          *matHeaderCellDef>{{header.viewValue}}
                      </th>
                      <td mat-cell
                          *matCellDef="let element">
                        {{ getDisplayBrewIngredient(header.value, element) }}
                      </td>
                    </ng-container>
                    <tr mat-header-row
                        class="tr-box"
                        *matHeaderRowDef="displayedColumnsBrewIngredient"></tr>
                    <tr mat-row
                        *matRowDef="let row; columns: displayedColumnsBrewIngredient;"></tr>
                  </table>
                </div>
              </td>
            </ng-container>

            <tr mat-header-row
                class="tr-box"
                *matHeaderRowDef="displayedColumnsStock"></tr>
            <tr mat-row
                *matRowDef="let row; columns: displayedColumnsStock;"
                class="element-row"></tr>
            <tr mat-row
                *matRowDef="let row; columns: ['expandedDetail']"
                class="detail-row"></tr>

          </mat-table>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
    <div class="inline-flex-invert">
      <button mat-button
              [disabled]="orderService.loadingSource || stockService.loadingSource || brewService.loadingSource"
              (click)="launchOrder($event)">
        <mat-icon>local_shipping</mat-icon>Passer la commande
      </button>
    </div>
  </fieldset>
</div>
