<div class="inline">
  <div class="brew-container"
       [@brewExpand]="orderDisplayService.brewExpanded ? 'expanded': 'collapsed'">
    <mat-selection-list class="brew-list"
                        #brews>
      <mat-list-option *ngFor="let brew of brewsDetail"
                       [value]="brew"
                       [selected]="brew.isApply">
        <mat-icon matListIcon
                  *ngIf="brew.canBeBrew">thumb_up</mat-icon>
        <mat-icon matListIcon
                  *ngIf="!brew.canBeBrew">warning</mat-icon>
        <div class="brew-custom-placeholder"></div>
        {{brew.brew.number}} - {{brew.brew.name}}<br />{{brew.brew.started | date: 'dd-M-yyyy' }}
      </mat-list-option>
    </mat-selection-list>
  </div>

  <fieldset [disabled]="stockService.loadingSource"
            class="full-width padding">
    <mat-accordion multi>
      <mat-expansion-panel *ngFor="let accordion of accordionOrder"
                           [expanded]="accordion.expanded">
        <mat-expansion-panel-header>
          <mat-panel-title>
            {{accordion.childName.viewValue}}
          </mat-panel-title>
        </mat-expansion-panel-header>
        <div class="table-responsive">
          <mat-table class="full-width"
                     #matTable
                     matSort
                     multiTemplateDataRows
                     [dataSource]="accordion.orderStocks">
            <ng-container matColumnDef="expanded">
              <th mat-header-cell
                  *matHeaderCellDef>
              </th>
              <td mat-cell
                  (click)="selectedRow($event, row)"
                  *matCellDef="let row"
                  class="cursor">
                <div class="expanded">
                  <mat-icon *ngIf="row.expanded">expand_less</mat-icon>
                  <mat-icon *ngIf="!row.expanded">expand_more</mat-icon>
                </div>
              </td>
            </ng-container>
            <ng-container [matColumnDef]="header.value"
                          *ngFor="let header of headersStock">
              <th mat-header-cell
                  class="header-box"
                  [mat-sort-header]="header.value"
                  *matHeaderCellDef>{{header.viewValue}}
              </th>
              <td mat-cell
                  *matCellDef="let element">
                {{ getDisplay(header.value, element) }}
              </td>
            </ng-container>
            <ng-container matColumnDef="action">
              <th mat-header-cell
                  *matHeaderCellDef>
              </th>
              <td mat-cell
                  *matCellDef="let element">
                <div class="action-container">
                  <ng-container *ngIf="element.orderStocks.length === 1">
                    <ng-container
                                  *ngTemplateOutlet="orderStock; context: {element: element, stock: element.orderStocks[0], index: 0}">
                    </ng-container>
                    <button mat-icon-button
                            (click)="addNewStockOrder($event, element)"
                            [attr.aria-label]="'Ajouter un nouvel ingrédient'">
                      <mat-icon>add_task</mat-icon>
                    </button>
                  </ng-container>
                  <div *ngIf="element.orderStocks.length > 1">
                    {{getDisplay('quantityOrder', element)}}
                    <mat-icon svgIcon="truck-delivery"
                              *ngIf="getDisplay('displayTruck', element)"></mat-icon>
                    {{getDisplay('lastDeliverySchedule', element)}}
                  </div>
                </div>
              </td>
            </ng-container>
            <ng-container matColumnDef="expandedDetail">
              <td mat-cell
                  *matCellDef="let element"
                  [attr.colspan]="displayedColumnsStock.length">
                <div class="element-detail inline"
                     [@detailExpand]="element.expanded ? 'expanded' : 'collapsed'">
                  <ng-container *ngTemplateOutlet="listBrewElement; context: {element: element}"></ng-container>
                  <mat-list class="grow-twice"
                            *ngIf="element.orderStocks.length > 1">
                    <mat-list-item *ngFor="let stock of element.orderStocks; let index = index">
                      <ng-container
                                    *ngTemplateOutlet="orderStock; context: {element: element, stock: stock, index: index}">
                      </ng-container>
                    </mat-list-item>
                    <mat-list-item>
                      <button mat-icon-button
                              (click)="addNewStockOrder($event, element)"
                              [attr.aria-label]="'Ajouter un nouvel ingrédient'">
                        <mat-icon>add_task</mat-icon>
                      </button>
                    </mat-list-item>
                  </mat-list>

                </div>
              </td>
            </ng-container>

            <tr mat-header-row
                class="tr-box"
                *matHeaderRowDef="displayedColumnsStock"></tr>
            <tr mat-row
                *matRowDef="let row; columns: displayedColumnsStock;"
                class="element-row"></tr>
            <tr mat-row
                *matRowDef="let row; columns: ['expandedDetail']"
                class="detail-row"></tr>

          </mat-table>
        </div>
      </mat-expansion-panel>
    </mat-accordion>
  </fieldset>
</div>

<ng-template let-element="element"
             let-stock="stock"
             let-index="index"
             #orderStock>
  <mat-form-field appearance="legacy"
                  class="quantityForm">
    <mat-label>Quantité</mat-label>
    <input matInput
           [placeholder]="'Ex: 23 ' + element.ingredient.unit"
           type="number"
           step="any"
           min="0"
           (change)="updateStock($event, element, stock, 'quantity')"
           [value]="stock.quantity / element.ingredient.unitFactor">
  </mat-form-field>
  <mat-form-field appearance="legacy"
                  class="supplierForm">
    <mat-label>Fournisseur</mat-label>
    <app-supplier-select-input #supplier
                               [value]="stock.supplier"
                               [disabled]="!stock.id"
                               (newSupplier)="updateStockSupplier($event, element, stock)"
                               placeholder="Fournisseur"></app-supplier-select-input>
  </mat-form-field>
  <mat-form-field appearance="legacy"
                  class="deliveryScheduledForm">
    <mat-label>Livraison prévue</mat-label>
    <input matInput
           [disabled]="!stock.id || stockService.loadingSource"
           [matDatepicker]="deliveryScheduledFor"
           (dateInput)="updateDate($event, element, stock, 'deliveryScheduledFor')"
           (dateChange)="updateDate($event, element, stock, 'deliveryScheduledFor')"
           [value]="stock.deliveryScheduledFor">
    <mat-datepicker-toggle matSuffix
                           [for]="deliveryScheduledFor"></mat-datepicker-toggle>
    <mat-datepicker #deliveryScheduledFor></mat-datepicker>
  </mat-form-field>
  <mat-form-field appearance="legacy"
                  class="priceForm">
    <mat-label>Prix</mat-label>
    <input matInput
           [placeholder]="'Ex: 23 €'"
           type="number"
           step="any"
           min="0"
           (change)="updateStock($event, element, stock, 'price')"
           [value]="stock.price">
  </mat-form-field>
  <button mat-icon-button
          *ngIf="stock.id > 0 || index > 0"
          (click)="removeStockOrder($event, element, index)">
    <mat-icon>remove_circle_outline</mat-icon>
  </button>
  <button mat-icon-button
          *ngIf="!stock.id && index < 1"
          disabled></button>
</ng-template>

<ng-template #listBrewElement
             let-element="element">
  <mat-list>
    <mat-list-item *ngFor="let brewElement of element.brewIngredients">
      {{getDisplayBrewIngredient('brewName', brewElement)}} <mat-icon svgIcon="arrow-right"></mat-icon>
      {{getDisplayBrewIngredient('quantity', brewElement)}} {{getDisplayBrewIngredient('unit', brewElement)}} - 
      <mat-chip-list>
        <mat-chip [color]="brewElement.quantityLeft > 0 ? 'accent' : 'primary'"
                  [selected]="brewElement.quantityLeft > 0">
          {{getDisplayBrewIngredient('quantityMissing', brewElement)}} {{getDisplayBrewIngredient('unit', brewElement)}}
        </mat-chip>
      </mat-chip-list>
    </mat-list-item>
  </mat-list>
</ng-template>
<ng-template #tableBrewElement
             let-element="element">
  <div class="table-responsive">
    <table mat-table
           class="full-width"
           matSort
           [dataSource]="element.brewIngredients">
      <ng-container [matColumnDef]="header.value"
                    *ngFor="let header of headersBrewIngredient">
        <th mat-header-cell
            class="header-box"
            [mat-sort-header]="header.value"
            *matHeaderCellDef>{{header.viewValue}}
        </th>
        <td mat-cell
            *matCellDef="let element">
          {{ getDisplayBrewIngredient(header.value, element) }}
        </td>
      </ng-container>
      <tr mat-header-row
          class="tr-box"
          *matHeaderRowDef="displayedColumnsBrewIngredient"></tr>
      <tr mat-row
          *matRowDef="let row; columns: displayedColumnsBrewIngredient;"></tr>
    </table>
  </div>
</ng-template>
