<div class="tab">
  <div class="auto">
    <div class="inline-header">
      <button mat-button
              (click)="openCreateDialog()"
              [matTooltip]="'Ajouter un brassin'">
        <mat-icon>add_circle_outline</mat-icon>
        <mat-label> Ajouter un brassin</mat-label>
      </button>
    </div>
    <table mat-table
           class="full-width"
           #matTable
           matSort
           cdkDropList
           multiTemplateDataRows
           (cdkDropListDropped)="dropListDropped($event)"
           cdkDropListOrientation="horizontal"
           [dataSource]="dataSource">
      <ng-container [matColumnDef]="header.value"
                    *ngFor="let header of service.headers">
        <th mat-header-cell
            class="header-box"
            cdkDrag
            cdkDragLockAxis="x"
            [cdkDragData]="header"
            cdkDragBoundary=".tr-box"
            [mat-sort-header]="header.value"
            *matHeaderCellDef>{{header.viewValue}}
        </th>
        <td mat-cell
            *matCellDef="let element">
          <span> {{ service.getDisplay(header.value, element) }} </span>
        </td>
      </ng-container>
      <ng-container matColumnDef="expandedDetail">
        <td mat-cell
            *matCellDef="let element"
            [attr.colspan]="service.displayedColumns.length">
          <div class="element-detail"
               [@detailExpand]="element === selected ? 'expanded' : 'collapsed'">
            <div class="flex">
              <div>
                <div class="element-diagram">
                  <div class="element-name"> {{element.name}} <span class="element-description">
                      {{element.state}} </span></div>
                  <div class="element-specification"> {{element.abv}} {{element.ibu}} {{element.ebc}} </div>
                </div>
                <div class="element-diagram">
                  <div class="element-date">Créé le : {{element.created | date: 'y-MM-dd HH:mm'}} </div>
                  <div class="element-date"
                       *ngIf="element.started">Commence le : {{element.started | date: 'y-MM-dd HH:mm'}} </div>
                  <div class="element-date"
                       *ngIf="element.ended">Termine le : {{element.ended | date: 'y-MM-dd HH:mm'}} </div>
                </div>
              </div>
              <!-- On part sur de l'auto-save, plus ergonomic.
              À chaque ajout, on ajoute directement la ligne dans le brassin en utilisant le post sur l'ingredient du brassin.
              De la même manière lorsque l'on met à jour la quantité met en utilisant le patch.
              -->
              <!-- Ajoute un nouvel ingrédient au brassin. -->
              <div>
                <button mat-button
                        (click)="addIngredient(element)">
                  <mat-icon>add</mat-icon>
                </button>
                <div class="element-listing"
                     *ngIf="!serviceIngredient.loadingSource">
                  <mat-list>
                    <ng-container *ngFor="let children of serviceIngredient.ingredientChildrenNames">
                      <ng-container *ngIf="hasChildren(element, children.value)">
                        <div mat-subheader>
                          {{children.viewValue}}
                        </div>
                        <mat-list-item *ngFor="let brewIngredient of getChildren(element, children.value)">
                          <div mat-line>
                            <!-- use a disabled button to provide padding for tree leaf -->
                            <button mat-icon-button
                                    disabled></button>
                            {{brewIngredient.stock.ingredient.brewView()}}
                            <mat-form-field>
                              <mat-label>Quantité ({{brewIngredient.stock.ingredient.unit}})</mat-label>
                              <input matInput
                                     [placeholder]="'Ex: 23 ' + brewIngredient.stock.ingredient.unit"
                                     type="number"
                                     (change)="updateIngredient($event, element, brewIngredient)"
                                     [value]="brewIngredient.quantity">
                            </mat-form-field>
                            <button mat-icon-button>
                              <mat-icon>delete</mat-icon>
                            </button>
                          </div>
                        </mat-list-item>
                      </ng-container>
                    </ng-container>
                  </mat-list>
                  <!-- Affichage des brewIngredient sous forme de tree -->
                </div>
              </div>
            </div>
          </div>
        </td>
      </ng-container>
      <ng-container matColumnDef="action">
        <th mat-header-cell
            *matHeaderCellDef>
        </th>
        <td mat-cell
            *matCellDef="let row">
          <div class="action-container">
            <button mat-icon-button
                    (click)="openUpdateDialog(row)"
                    [attr.aria-label]="'Met à jour ' + service.getDisplay('name',row)">
              <mat-icon>update</mat-icon>
            </button>
            <button mat-icon-button
                    (click)="openDeleteDialog(row, service.getDisplay('name', row))"
                    [attr.aria-label]="'Supprime ' + service.getDisplay('name',row)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>
      <tr mat-header-row
          class="tr-box"
          *matHeaderRowDef="service.displayedColumns"></tr>
      <tr mat-row
          *matRowDef="let row; columns: service.displayedColumns;"
          class="element-row"
          [class.expanded-row]="selected === row"
          (click)="selected = selected === row ? null : row"></tr>
      <tr mat-row
          *matRowDef="let row; columns: ['expandedDetail']"
          class="detail-row"></tr>
    </table>
    <app-pagination [paginate]="service.paginate"></app-pagination>
  </div>
</div>
